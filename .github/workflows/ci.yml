name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  actions: read

jobs:
  select-runner:
    runs-on: ubuntu-latest
    outputs:
      runner: ${{ steps.pick.outputs.runner }}
    steps:
      - id: pick
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ONLINE=$(gh api "repos/${{ github.repository }}/actions/runners" \
            --jq '[.runners[] | select(.status=="online") | select([.labels[].name] | contains(["self-hosted","Linux","X64"]))] | length' \
            2>/dev/null) || ONLINE=0
          if [ "${ONLINE:-0}" -gt 0 ]; then
            echo 'runner=["self-hosted","Linux","X64"]' >> "$GITHUB_OUTPUT"
          else
            echo 'runner="ubuntu-latest"' >> "$GITHUB_OUTPUT"
          fi

  build:
    runs-on: ${{ fromJSON(needs.select-runner.outputs.runner) }}
    needs: select-runner
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install -r requirements-dev.txt

  test:
    runs-on: ${{ fromJSON(needs.select-runner.outputs.runner) }}
    needs: [build, select-runner]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install -r requirements-dev.txt
      - run: pytest --cov=src --cov-report=term-missing

  test-windows:
    runs-on: windows-latest
    needs: build
    env:
      PYTHONUTF8: '1'
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      - name: Run tests
        run: pytest -q

  lint:
    runs-on: ${{ fromJSON(needs.select-runner.outputs.runner) }}
    needs: [test, test-windows, select-runner]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install ruff
      - run: ruff check src/ tests/

  docstring-lint:
    name: Docstring quality
    runs-on: ${{ fromJSON(needs.select-runner.outputs.runner) }}
    needs: [build, select-runner]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install quality tools
        run: pip install pydocstyle docstr-coverage
      - name: pydocstyle (Google convention)
        run: |
          pydocstyle src/ \
            --convention=google \
            --add-ignore=D100,D104 \
            || true   # Warn-only; remove "|| true" to make it a hard failure
      - name: docstr-coverage (min 70%)
        run: |
          docstr-coverage src/ \
            --fail-under=70 \
            --exclude='.*__pycache__.*' \
            --verbose=2

  docs-build:
    name: Sphinx HTML build
    runs-on: ${{ fromJSON(needs.select-runner.outputs.runner) }}
    needs: [lint, docstring-lint, select-runner]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install PlantUML
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y plantuml
      - name: Install runtime dependencies
        run: pip install -r requirements.txt
      - name: Install docs dependencies
        run: pip install -r docs/requirements.txt
      - name: Build HTML docs
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          sphinx-build \
            -b html \
            -W --keep-going \
            -n \
            docs \
            docs/_build/html

  docker:
    runs-on: ${{ fromJSON(needs.select-runner.outputs.runner) }}
    needs: [docs-build, select-runner]
    steps:
      - uses: actions/checkout@v4
      - run: docker build -t telechatbot .
