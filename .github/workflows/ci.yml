name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  actions: read

jobs:
  select-runner:
    runs-on: ubuntu-latest
    outputs:
      runner: ${{ steps.pick.outputs.runner }}
    steps:
      - id: pick
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ONLINE=$(gh api "repos/${{ github.repository }}/actions/runners" \
            --jq '[.runners[] | select(.status=="online") | select([.labels[].name] | contains(["self-hosted","Linux","X64"]))] | length' \
            2>/dev/null) || ONLINE=0
          if [ "${ONLINE:-0}" -gt 0 ]; then
            echo 'runner=["self-hosted","Linux","X64"]' >> "$GITHUB_OUTPUT"
          else
            echo 'runner="ubuntu-latest"' >> "$GITHUB_OUTPUT"
          fi

  build:
    runs-on: ${{ fromJSON(needs.select-runner.outputs.runner) }}
    needs: select-runner
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install -r requirements-dev.txt

  test:
    runs-on: ${{ fromJSON(needs.select-runner.outputs.runner) }}
    needs: [build, select-runner]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install -r requirements-dev.txt
      - run: pytest --cov=src --cov-report=term-missing

  test-windows:
    runs-on: windows-latest
    needs: build
    env:
      PYTHONUTF8: '1'
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      - name: Run tests
        run: pytest -q

  lint:
    runs-on: ${{ fromJSON(needs.select-runner.outputs.runner) }}
    needs: [test, test-windows, select-runner]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install ruff
      - run: ruff check src/ tests/

  docker:
    runs-on: ${{ fromJSON(needs.select-runner.outputs.runner) }}
    needs: [lint, select-runner]
    steps:
      - uses: actions/checkout@v4
      - run: docker build -t telechatbot .
