name: Build and deploy docs to GitHub Pages

on:
  push:
    branches:
      - main
    paths:
      - "docs/**"
      - "src/**"
      - ".github/workflows/docs-gh-pages.yml"
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  # ------------------------------------------------------------------ #
  # Job 1: docstring quality gate
  # ------------------------------------------------------------------ #
  docstring-check:
    name: Docstring quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install quality tools
        run: pip install pydocstyle docstr-coverage

      - name: pydocstyle (Google convention)
        run: |
          pydocstyle src/ \
            --convention=google \
            --add-ignore=D100,D104 \
            || true   # Warn-only; remove "|| true" to make it a hard failure

      - name: docstr-coverage (min 70%)
        run: |
          docstr-coverage src/ \
            --fail-under=70 \
            --exclude='.*__pycache__.*' \
            --verbose=2

  # ------------------------------------------------------------------ #
  # Job 2: Sphinx build + GitHub Pages deploy
  # ------------------------------------------------------------------ #
  docs:
    name: Sphinx HTML â†’ gh-pages
    runs-on: ubuntu-latest
    needs: docstring-check
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0   # full history for git blame / changelog

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      # Install PlantUML (needed by sphinxcontrib-plantuml)
      - name: Install PlantUML
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y plantuml

      # Install runtime deps so autodoc can import the modules
      - name: Install runtime dependencies
        run: pip install -r requirements.txt

      # Install Sphinx + extensions
      - name: Install docs dependencies
        run: pip install -r docs/requirements.txt

      # Build HTML documentation
      - name: Build HTML docs
        env:
          PYTHONPATH: .
        run: |
          sphinx-build \
            -b html \
            -W --keep-going \
            -n \
            docs \
            docs/_build/html

      # Upload artifact for GitHub Pages
      - name: Upload pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/_build/html

      # Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
